define(function(b,a,c){b.async(["./infoviz.core"],function(d){a.draw_basictree=function(l,B,au,Z,ai,af){if(!l||!au){return idb("Paper or Data is empty.")}var T=d.merge_options(Z),D=[],aj,ah,aq,ap,aa;var s=function(aA){var aC=[],ay=[],y={};var az=0,j;aA._id="n_"+az++;aC.push({_id:aA._id,node:aA});y[aA._id]={index:aC.length-1,parent_id:undefined,count_direct:aA.children.length,count_leaf:0};ay.push(aA);var aB,aw,ax;while(ay.length>0){aB=ay[0];ay=ay.slice(1);ax=aB._id;if(!aB.children){aB.children=[]}for(aw=0;aw<aB.children.length;++aw){aB.children[aw]["_id"]="n_"+az++;aC.push({_id:aB.children[aw]["_id"],node:aB.children[aw]});y[aB.children[aw]["_id"]]={index:aC.length-1,parent_id:ax,count_direct:aB.children[aw]["children"]?aB.children[aw]["children"].length:0,count_leaf:0};ay.push(aB.children[aw])}}for(var p in y){j=0;aB=y[p];while(aB.parent_id!==undefined){if(aB.count_direct===0){var x=aB;while(x.parent_id!==undefined){y[x.parent_id]["count_leaf"]+=1;x=y[x.parent_id]}}aB=y[aB.parent_id];++j}y[p]["level"]=j}return{set:aC,dictionary:y}};var W=au.data;var M=s(W);var I=[],N=0;var X=M.set,K=M.dictionary;for(id in K){t=K[id];if(!I[t.level]){I[t.level]={count_node:0,nodes:[]};N++}I[t.level]["count_node"]++;I[t.level]["nodes"].push(X[t.index]["_id"])}var J=-Infinity,ao=Infinity,C=0;var an=-Infinity,H=Infinity,ag=0;for(aq=0;aq<X.length;++aq){K[X[aq]["_id"]]["_color"]=T.color[(aq%T.color.length)];var o=X[aq]["node"][au.node_value_field];if(d.is_number(o)){if(o>J){J=o}if(o<ao){ao=o}C+=o}var n=X[aq]["node"][au.edge_value_field];if(d.is_number(n)){if(n>an){an=n}if(n<H){H=n}ag+=n}}var f=B.width-T.basictree["padding-left"]-T.basictree["padding-right"];var m=B.height-T.basictree["padding-top"]-T.basictree["padding-bottom"];var at=B["top-left"][0]+T.basictree["padding-left"];var ar=B["top-left"][1]+T.basictree["padding-top"];aj=at+f/2;ah=ar+T.basictree["node-max-radius"];var ad=(T.basictree["node-max-radius"]-T.basictree["node-min-radius"])/(J-ao);if(J===ao){ad=0}var ae;if(N>0){ae=m/N}else{ae=m}var O,g=[];var q,F=[];var Y,av=[];for(aq=0;aq<I.length;++aq){for(ap=0;ap<I[aq]["nodes"].length;++ap){var ak=K[I[aq]["nodes"][ap]];if(aq===0){var v,ak,S,am;var z=X[0]["node"][au.node_value_field];var k=(z-ao)*ad+T.basictree["node-min-radius"];O=l.circle(aj,ah,k).attr({"stroke-width":T.basictree["node-border-width"],stroke:K[X[0]["_id"]]["_color"]["color"],fill:K[X[0]["_id"]]["_color"]["color"],"fill-opacity":K[X[0]["_id"]]["_color"]["light-alpha"]}).translate(0.5,0.5);g.push(O);K[X[0]["_id"]]["_x"]=aj;K[X[0]["_id"]]["_y"]=ah;K[X[0]["_id"]]["_r"]=k;K[X[0]["_id"]]["_space"]=f;K[X[0]["_id"]]["_current"]=at}else{S=K[ak.parent_id];am=S._space/S.count_direct;z=X[ak.index]["node"][au.node_value_field];v=X[ak.index]["node"][au.edge_value_field];k=(z-ao)*ad+T.basictree["node-min-radius"];aj=S._current+am/2;O=l.circle(aj,ah,k).attr({"stroke-width":T.basictree["node-border-width"],stroke:ak._color["color"],fill:ak._color["color"],"fill-opacity":ak._color["light-alpha"]}).translate(0.5,0.5);if(T.layout["shadow-enabled"]){O.glow({width:T.layout["shadow-width"],fill:false,opacity:T.layout["shadow-alpha"],offsetx:T.layout["shadow-offset-x"],offsety:T.layout["shadow-offset-y"],color:T.layout["shadow-color"]})}g.push(O);S._current+=am;ak._x=aj;ak._y=ah;ak._space=am;ak._r=k;ak._current=aj-am/2}var E=X[ak.index]["node"][au.node_label_field];if(E&&T.basictree["node-label-size"]>0){q=l.text(aj,ah,E).attr({"text-anchor":"middle","font-size":T.basictree["node-label-size"],fill:T.basictree["node-label-color"]}).translate(0.5,0.5);F.push(q)}if(ai&&typeof(ai)==="function"){O.data("info",{x:aj,y:ah,type:"node",radius:k,data:X[ak.index]["node"],callback:ai,that:af});O.click(d.element_action);if(q){q.data("info",{x:aj,y:ah,type:"label",radius:k,data:X[ak.index]["node"],callback:ai,that:af});q.click(d.element_action)}}if(au.node_tooltip_title||au.node_tooltip_content){var ac=au.node_tooltip_title;var A=au.node_tooltip_content;var aa=X[ak.index]["node"];for(var al in aa){ac=ac.replace("{"+al+"}",aa[al]);A=A.replace("{"+al+"}",aa[al])}O.data("tooltip",{id:"n_"+aq+"_"+ap,title:ac,content:A,color:K[aa._id]["_color"],x:aj,y:ah-k,element:q,options:T,paper:l});O.hover(d.element_tooltip)}if(S){var Q=aj,P=ah;var u=S._x,r=S._y;var L=Math.atan((r-P)/(u-Q));var V=S._r;if(u>=Q){Q+=k*Math.cos(L);P+=k*Math.sin(L);u-=V*Math.cos(L);r-=V*Math.sin(L)}else{Q-=k*Math.cos(L);P-=k*Math.sin(L);u+=V*Math.cos(L);r+=V*Math.sin(L)}var e=l.path("M"+Q+","+P+"L"+u+","+r).attr({"stroke-width":T.basictree["edge-width"],stroke:T.basictree["edge-color"],"stroke-opacity":T.basictree["edge-alpha"]}).translate(0.5,0.5);if(T.layout["shadow-enabled"]){e.glow({width:T.layout["shadow-width"],fill:false,opacity:T.layout["shadow-alpha"],offsetx:T.layout["shadow-offset-x"],offsety:T.layout["shadow-offset-y"],color:T.layout["shadow-color"]})}if(v&&T.basictree["edge-label-size"]>0){var U=(Q+u)/2;var R=(P+r)/2;var h=l.text(-1000,-1000,v).attr({"font-size":T.basictree["edge-label-size"]}).translate(0.5,0.5);var w=h.getBBox();var ab=w.width+T.basictree["edge-box-padding-left"]+T.basictree["edge-box-padding-right"];var G=w.height+T.basictree["edge-box-padding-top"]+T.basictree["edge-box-padding-bottom"];Y=l.rect(U-ab/2,R-G/2,ab,G,T.basictree["edge-box-border-radius"]).attr({stroke:T.basictree["edge-box-border-color"],"stroke-width":T.basictree["edge-box-border-width"],"stroke-opacity":T.basictree["edge-box-border-alpha"],fill:T.basictree["edge-box-background-color"],"fill-opacity":T.basictree["edge-box-background-alpha"]}).translate(0.5,0.5);av.push(Y);q=l.text(U,R,v).attr({"text-anchor":"middle","font-size":T.basictree["edge-label-size"],fill:T.basictree["edge-label-color"]}).translate(0.5,0.5);F.push(q);if(ai&&typeof(ai)==="function"){q.data("info",{x:U,y:R,type:"edge",data:X[ak.index]["node"],callback:ai,that:af});q.click(d.element_action)}if(au.edge_tooltip_title||au.edge_tooltip_content){var ac=au.edge_tooltip_title;var A=au.edge_tooltip_content;var aa=X[ak.index]["node"];for(var al in aa){ac=ac.replace("{"+al+"}",aa[al]);A=A.replace("{"+al+"}",aa[al])}q.data("tooltip",{id:"e_"+aq+"_"+ap,title:ac,content:A,color:K[aa._id]["_color"],x:U,y:R-G/2,element:q,options:T,paper:l});q.hover(d.element_tooltip)}}}}ah+=ae}for(aq=0;aq<g.length;++aq){g[aq].toFront()}for(aq=0;aq<av.length;++aq){av[aq].toFront()}for(aq=0;aq<F.length;++aq){F[aq].toFront()}}})});